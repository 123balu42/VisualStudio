<local:GenericPullRequestDetailView x:Class="GitHub.VisualStudio.UI.Views.PullRequestDetailView"
                                    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                                    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                                    xmlns:cache="clr-namespace:GitHub.VisualStudio.Helpers"
                                    xmlns:local="clr-namespace:GitHub.VisualStudio.UI.Views"
                                    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                                    xmlns:sampleData="clr-namespace:GitHub.SampleData;assembly=GitHub.App"
                                    xmlns:ui="clr-namespace:GitHub.UI;assembly=GitHub.UI"
                                    xmlns:vm="clr-namespace:GitHub.ViewModels;assembly=GitHub.App"
                                    xmlns:te="clr-namespace:Microsoft.TeamFoundation.Controls.WPF.TeamExplorer.Framework;assembly=Microsoft.TeamFoundation.Controls"
                                    Background="{DynamicResource GitHubVsToolWindowBackground}"
                                    DataContext="{Binding ViewModel}"
                                    d:DesignWidth="356"
                                    d:DesignHeight="640"
                                    mc:Ignorable="d">
    <d:DesignProperties.DataContext>
        <Binding>
            <Binding.Source>
                <sampleData:PullRequestDetailViewModelDesigner />
            </Binding.Source>
        </Binding>
    </d:DesignProperties.DataContext>

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <cache:SharedDictionaryManager Source="pack://application:,,,/GitHub.VisualStudio.UI;component/SharedDictionary.xaml" />
                <cache:SharedDictionaryManager Source="pack://application:,,,/GitHub.UI;component/SharedDictionary.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <Style x:Key="Separator1" TargetType="Rectangle">
                <Setter Property="Fill" Value="#D3D1E6"/>
            </Style>

            <Style x:Key="Separator2" TargetType="Rectangle">
                <Setter Property="Fill" Value="#E2E6EE"/>
            </Style>

            <Style x:Key="DocumentStyle" TargetType="FlowDocument">
                <Setter Property="FontFamily" Value="Segoe UI"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="TextAlignment" Value="Left"/>
                <Setter Property="PagePadding" Value="0"/>
            </Style>

            <!-- TODO Fix this: here we change the color of TextBlock depending on the label.
                 It's a hack, it will break with localization -->
            <Style x:Key="StateIndicator" TargetType="TextBlock">
                <Style.Triggers>
                    <Trigger Property="Text" Value="Open">
                        <Setter Property="Background" Value="#6CC644"/>
                    </Trigger>
                    <Trigger Property="Text" Value="Closed">
                        <Setter Property="Background" Value="#BD2C00"/>
                    </Trigger>
                    <Trigger Property="Text" Value="Merged">
                        <Setter Property="Background" Value="#6E5494"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <DockPanel Grid.IsSharedSizeScope="True">
        <!-- PR Title and number -->
        <DockPanel DockPanel.Dock="Top"
                   Margin="8 0 8 8">
            <TextBlock DockPanel.Dock="Right"
                       FontSize="9pt"
                       Foreground="Gray"
                       Margin="4 4 0 0"
                       Text="{Binding Number, StringFormat=#{0}}"
                       VerticalAlignment="Top"/>
            <TextBlock Text="{Binding Title}"
                       FontSize="12pt"
                       TextWrapping="Wrap"/>
        </DockPanel>

        <Rectangle DockPanel.Dock="Top" Style="{StaticResource Separator1}" Height="2"/>

        <!-- PR Overview -->
        <Grid DockPanel.Dock="Top">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" SharedSizeGroup="LeftMargin"/>
                <ColumnDefinition Width="6" SharedSizeGroup="LeftMarginSpace"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Open/closed state and branches -->
                <RowDefinition Height="2"/>
                <RowDefinition Height="Auto"/> <!-- Commit and files changed count -->
                <RowDefinition Height="2"/>
                <RowDefinition Height="Auto"/> <!-- Checkout button -->
            </Grid.RowDefinitions>
            
            <!-- PR Icon in left margin -->
            <ui:OcticonImage Grid.Column="0"
                             Margin="8"
                             VerticalAlignment="Top"
                             Icon="git_pull_request"/>

            <!-- Open/closed state and branches -->
            <StackPanel Grid.Column="2" Grid.Row="0" Orientation="Horizontal" Margin="0 6">
                <TextBlock Padding="14 4" Margin="0 0 12 0"
                           Foreground="White"
                           Text="{Binding State}"
                           Style="{StaticResource StateIndicator}"/>

                <TextBlock Text="{Binding TargetBranchDisplayName}" VerticalAlignment="Center"/>
                <ui:OcticonImage Icon="chevron_left" Height="13" Margin="1 0 3 0"/>
                <TextBlock Text="{Binding SourceBranchDisplayName}" VerticalAlignment="Center" 
                           ToolTip="{Binding SourceBranchDisplayName}"/>
            </StackPanel>

            <Rectangle Grid.Column="2" Grid.Row="1" Margin="-2 0 0 0" Style="{StaticResource Separator2}"/>

            <!-- Commit and files changed count -->
            <StackPanel Grid.Column="2" Grid.Row="2" Orientation="Horizontal" Margin="0 6">
                <ui:OcticonImage Icon="git_commit" Margin="0 1 2 0"/>
                <TextBlock Margin="2 0"
                           VerticalAlignment="Center"
                           Text="{Binding CommitCount, StringFormat={}{0} commits}"/>

                <ui:OcticonImage Icon="diff" Margin="28 0 2 0"/>
                <TextBlock Margin="2 0"
                           VerticalAlignment="Center"
                           Text="{Binding FilesChangedCount, StringFormat={}{0} files changed}"/>
            </StackPanel>

            <Rectangle Grid.Column="2" Grid.Row="3" Margin="-2 0 0 0" Style="{StaticResource Separator2}"/>

            <Button Grid.Column="2" Grid.Row="4" Margin="0 6"
                    Style="{StaticResource GitHubVsButton}">
                Checkout pull request
            </Button>
        </Grid>

        <Rectangle DockPanel.Dock="Top" Style="{StaticResource Separator1}" Height="2"/>

        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="LeftMargin"/>
                    <ColumnDefinition Width="6" SharedSizeGroup="LeftMarginSpace"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Author and open time -->
                    <RowDefinition Height="Auto"/> <!-- PR body -->
                    <RowDefinition Height="Auto"/> <!-- View on github link -->
                    <RowDefinition Height="Auto"/> <!-- Files changed -->
                </Grid.RowDefinitions>

                <!-- Author avatar -->
                <Grid Grid.Column="0" Grid.Row="0" VerticalAlignment="Top" Margin="0 8">
                    <Grid.OpacityMask>
                        <VisualBrush Visual="{Binding ElementName=avatarMask}"/>
                    </Grid.OpacityMask>
                    <Border Name="avatarMask" Background="White" CornerRadius="3" Width="24" />
                    <Image x:Name="avatar"
                   Width="24"
                   Height="24"
                   RenderOptions.BitmapScalingMode="HighQuality"
                   Source="{Binding Author.Avatar}" />
                </Grid>

                <!-- Author and open time -->
                <TextBlock Grid.Column="2" Grid.Row="0" VerticalAlignment="Center" Margin="0 6">
                    <Run FontWeight="Bold" Text="{Binding Author.Login}"/>
                    <Run Text="{Binding CreatedAt, StringFormat={}opened {0}, Converter={ui:DurationToStringConverter}, Mode=OneWay}"/>
                </TextBlock>

                <!-- PR Body -->
                <ui:MarkdownViewer Grid.Column="2" Grid.Row="1"
                                   Margin="2 6 10 6"
                                   DocumentStyle="{StaticResource DocumentStyle}"
                                   RawContent="{Binding Body}"
                                   ScrollViewer.VerticalScrollBarVisibility="Auto"/>

                <!-- View on github link -->
                <ui:GitHubActionLink Grid.Column="2" Grid.Row="2" Margin="0 6">
                    View conversation on GitHub
                </ui:GitHubActionLink>

                <!-- Files changed Icon in left margin -->
                <ui:OcticonImage Grid.Column="0" Grid.Row="3"
                                 Margin="8"
                                 VerticalAlignment="Top"
                                 Icon="diff"/>

                <!-- Files changed -->
                <te:SectionControl Grid.Column="2" Grid.Row="3"
                                   IsExpanded="True"
                                   HeaderText="{Binding ChangeCount, StringFormat=Changes ({0})}"
                                   Margin="0 5 10 0">
                    <te:SectionControl.Content>
                        <TreeView ItemsSource="{Binding Changes}" BorderThickness="0">
                            <TreeView.ItemContainerStyle>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="IsExpanded" Value="True"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                            <TreeView.Resources>
                                <HierarchicalDataTemplate DataType="{x:Type vm:PullRequestDirectoryViewModel}"
                                                      ItemsSource="{Binding Children}">
                                    <StackPanel Orientation="Horizontal">
                                        <!-- TODO: Use the right icon here -->
                                        <ui:OcticonImage Icon="briefcase" Margin="4"/>
                                        <TextBlock Text="{Binding DirectoryName}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                                <DataTemplate DataType="{x:Type vm:PullRequestFileViewModel}">
                                    <StackPanel Orientation="Horizontal">
                                        <ui:OcticonImage Icon="file_code" Margin="4"/>
                                        <TextBlock Text="{Binding FileName}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </DataTemplate>
                            </TreeView.Resources>
                        </TreeView>
                    </te:SectionControl.Content>
                </te:SectionControl>
            </Grid>
        </ScrollViewer>

    </DockPanel>
</local:GenericPullRequestDetailView>
